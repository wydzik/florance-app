{% extends "base.html" %}
{% block content %}
<h2>{{ realizacja.nazwa_eventu }}</h2>
{% if is_owner %}
  <a href="{% url 'edit_realizacja' realizacja.id %}"
     class="btn btn-outline-secondary btn-sm">
    Edytuj realizacjƒô
  </a>
{% endif %}
<div class="mb-3">
    <strong>Organizator:</strong><br>
    {{ realizacja.pracownia.nazwa }}<br>
    {{ realizacja.pracownia.owner.imie }}
    {{ realizacja.pracownia.owner.nazwisko }}
</div>


<p><strong>Miejsce:</strong> {{ realizacja.miejsce }}</p>
<p><strong>Data:</strong> {{ realizacja.data_rozpoczecia }} ‚Äì {{ realizacja.data_zakonczenia }}</p>
<p><strong>Opis:</strong> {{ realizacja.opis }}
{% if is_owner %}
  <a href="{% url 'edit_realizacja_opis' realizacja.id %}"
     class="btn btn-sm btn-outline-secondary">
    Edytuj opis
  </a>
{% endif %}
</p>

{% if pliki %}
<hr>
<h5>üìé Pliki do realizacji</h5>

<ul class="list-group mb-3">
  {% for plik in pliki %}
    <li class="list-group-item d-flex justify-content-between align-items-center">
      <div>
        <a href="{{ plik.plik.url }}" target="_blank">
          {{ plik.nazwa|default:plik.plik.name }}
        </a>

        {% if is_owner and plik.widocznosc == "owner" %}
          <span class="badge bg-secondary ms-2">Prywatny</span>
        {% endif %}
      </div>

      {% if is_owner %}
        <form method="post"
              action="{% url 'delete_realizacja_plik' plik.id %}">
          {% csrf_token %}
          <button class="btn btn-sm btn-outline-danger">
            Usu≈Ñ
          </button>
        </form>
      {% endif %}
    </li>
  {% endfor %}
</ul>

{% if is_owner %}
  <a href="{% url 'add_realizacja_plik' realizacja.id %}"
     class="btn btn-sm btn-outline-primary">
    ‚ûï Dodaj plik
  </a>
{% endif %}
{% endif %}
<hr>
<h5>üìé Pliki do realizacji</h5>

{% if realizacja.pliki.all %}
  <ul class="list-group mb-3">
    {% for plik in realizacja.pliki.all %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <a href="{{ plik.plik.url }}" target="_blank">
            {{ plik.nazwa|default:plik.plik.name }}
          </a>
          <br>
          <small class="text-muted">
            dodano: {{ plik.dodano|date:"d.m.Y H:i" }}
          </small>
        </div>

        {% if is_owner %}
          <form method="post"
                action="{% url 'delete_realizacja_plik' plik.id %}">
            {% csrf_token %}
            <button class="btn btn-sm btn-outline-danger">
              Usu≈Ñ
            </button>
          </form>
        {% endif %}
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p class="text-muted">Brak plik√≥w.</p>
{% endif %}

{% if is_owner %}
  <a href="{% url 'add_realizacja_plik' realizacja.id %}"
     class="btn btn-sm btn-outline-primary">
    ‚ûï Dodaj plik
  </a>
{% endif %}
{% endif %}

{% if is_owner %}
<hr>
<h5>üìù Prywatne notatki</h5>

<form method="post"
      action="{% url 'edit_realizacja_notatki' realizacja.id %}">
  {% csrf_token %}

  <textarea name="notatki_prywatne"
            class="form-control"
            rows="5"
            placeholder="Twoje prywatne notatki...">{{ realizacja.notatki_prywatne }}</textarea>

  <button class="btn btn-sm btn-outline-primary mt-2">
    Zapisz notatki
  </button>
</form>
{% endif %}


<hr>


{% if is_owner %}
    <a class="btn btn-primary" href="{% url 'create_pracownicy' realizacja.pk %}">Dodaj stanowisko</a>
    <a class="btn btn-primary" href="{% url 'lista_kandydatow' realizacja.id %}" >Zobacz kandydat√≥w</a>
{% endif %}

<table class="table table-striped mt-2">
  <thead>
    <tr>
      <th>Data pracy</th>
      <th>Transport</th>
      <th>D≈∫wiganie</th>
      <th>Uk≈Çadanie kwiat√≥w</th>
      <th>Prawo jazdy</th>
      <th>Stawka</th>
      <th>Min. godz.</th>
      <th>Szczeg√≥≈Çy</th>
      <th>Akcje</th>
    </tr>
  </thead>
 <tbody>
{% for s in stanowiska %}
<tr>
  <td>{{ s.data_pracy|date:"d.m.Y" }}</td>
  <td>{{ s.czy_wlasny_transport|yesno:"wymagany,nie" }}</td>
  <td>{{ s.czy_wymagane_dzwiganie|yesno:"tak,nie" }}</td>
  <td>{{ s.czy_wymagane_ukladanie_kwiatow|yesno:"tak,nie" }}</td>
  <td>{{ s.czy_wymagane_prawo_jazdy|default:"‚Äî" }}</td>
  <td>{{ s.stawka }} ({{ s.stawka_dzienna_czy_godzinowa }})</td>
  <td>{{ s.minimalny_czas_pracy }}</td>
  <td>{{ s.szczegoly|truncatechars:60 }}</td>

  <td>

  {% if is_owner %}

    {% if s.assigned_person_name %}
      <div class="mb-2">

        {% if s.przypisany_florysta %}
          <a href="{% url 'florysta_detail' s.przypisany_florysta.id %}"
             class="fw-semibold text-decoration-none">
            {{ s.assigned_person_name }}
          </a>
        {% else %}
          <a href="tel:{{ s.przypisany_telefon }}"
             class="fw-semibold text-decoration-none"
             data-bs-toggle="tooltip"
             title="Zadzwo≈Ñ: {{ s.przypisany_telefon }}">
            {{ s.assigned_person_name }}
          </a>
        {% endif %}

      </div>

      <a href="{% url 'assign_pracownik' realizacja.id s.id %}"
         class="btn btn-sm btn-outline-primary">
        Zmie≈Ñ przypisanie
      </a>

    {% else %}

      <a href="{% url 'assign_pracownik' realizacja.id s.id %}"
         class="btn btn-sm btn-primary">
        Przypisz osobƒô
      </a>

    {% endif %}

    <a href="{% url 'edit_pracownicy' realizacja.id s.id %}"
       class="btn btn-sm btn-outline-secondary">
      Edytuj
    </a>

    <button class="btn btn-sm btn-outline-danger"
            data-bs-toggle="modal"
            data-bs-target="#deleteModal{{ s.id }}">
      Usu≈Ñ
    </button>

    <tr>
  <td colspan="9">

    <div class="mt-2 p-3 bg-light rounded">

      <!-- Toggle -->
      <button class="btn btn-sm btn-outline-secondary"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#comments-{{ s.id }}">
        üí¨ Komentarze ({{ s.visible_comments|length }})
      </button>

      <div class="collapse mt-3" id="comments-{{ s.id }}">

        <!-- LISTA KOMENTARZY -->
        {% for komentarz in s.visible_comments %}
          <div class="border rounded p-2 mb-2 bg-white">

            <!-- Badge widoczno≈õci -->
            <div class="mb-1">
              {% if komentarz.typ == "owner" %}
                <span class="badge bg-secondary">
                  Tylko owner
                </span>
              {% elif komentarz.typ == "worker" %}
                <span class="badge bg-warning text-dark">
                  Prywatny dla pracownika
                </span>
              {% else %}
                <span class="badge bg-info text-dark">
                  Dla wszystkich pracownik√≥w
                </span>
              {% endif %}
            </div>

            <small class="text-muted">
              {{ komentarz.created_at|date:"d.m.Y H:i" }}
            </small>

            <p class="mb-0 mt-1">
              {{ komentarz.tresc|linebreaksbr }}
            </p>

          </div>
        {% empty %}
          <p class="text-muted">Brak komentarzy.</p>
        {% endfor %}


        <!-- FORMULARZ DODAWANIA (TYLKO OWNER) -->
        {% if is_owner %}
        <form method="post"
              action="{% url 'add_komentarz_stanowiska' s.id %}"
              class="mt-3">

          {% csrf_token %}

          <div class="mb-2">
            <textarea name="tresc"
                      class="form-control"
                      rows="2"
                      placeholder="Dodaj komentarz..."
                      required></textarea>
          </div>

          <div class="mb-2">
            <label class="form-label">Widoczno≈õƒá</label>
            <select name="typ"
                    class="form-select form-select-sm"
                    onchange="toggleWorkerSelect(this, {{ s.id }})"
                    required>
              <option value="owner">Tylko dla mnie (owner)</option>
              <option value="worker">Tylko dla przypisanego pracownika</option>
              <option value="all">Dla wszystkich pracownik√≥w realizacji</option>
            </select>
          </div>

          <!-- Wyb√≥r pracownika (pokazuje siƒô tylko przy typ=worker) -->
          <div class="mb-2 d-none"
               id="worker-select-{{ s.id }}">

            {% if s.przypisany_florysta %}
              <label class="form-label">
                Pracownik:
              </label>
              <input type="hidden"
                     name="widoczny_dla"
                     value="{{ s.przypisany_florysta.id }}">

              <div class="form-control form-control-sm bg-light">
                {{ s.przypisany_florysta.imie }}
                {{ s.przypisany_florysta.nazwisko }}
              </div>
            {% else %}
              <div class="text-muted small">
                Brak przypisanego pracownika
              </div>
            {% endif %}

          </div>

          <button class="btn btn-sm btn-outline-primary">
            Dodaj komentarz
          </button>

        </form>
        {% endif %}

      </div>
    </div>

  </td>
</tr>

  {% else %}

 {% if not request.user.is_authenticated %}

  {% if not s.is_filled %}
    <a href="{% url 'login' %}?next={{ request.path }}"
       class="btn btn-sm btn-success">
      Zaloguj siƒô, aby aplikowaƒá
    </a>
  {% else %}
    <span class="badge bg-success">
      Stanowisko obsadzone
    </span>
  {% endif %}

{% else %}

  {% if s.is_filled %}
    <span class="badge bg-success">
      Stanowisko obsadzone
    </span>

  {% elif s.already_applied %}
    <span class="badge bg-warning text-dark">
      Ju≈º aplikowa≈Çe≈õ
    </span>

  {% else %}
    <a href="{% url 'apply_stanowisko' s.id %}"
       class="btn btn-sm btn-success">
      Aplikuj
    </a>
  {% endif %}

{% endif %}

  {% endif %}

  </td>
</tr>

{% empty %}
<tr>
  <td colspan="9">
    Brak zdefiniowanych stanowisk dla tej realizacji.
  </td>
</tr>
{% endfor %}
</tbody>

</table>

{% if is_owner %}
{% for s in stanowiska %}
<div class="modal fade" id="deleteModal{{ s.id }}" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Usu≈Ñ stanowisko</h5>
        <button type="button" class="btn-close"
                data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        Czy na pewno chcesz usunƒÖƒá stanowisko z dnia
        <strong>{{ s.data_pracy|date:"d.m.Y" }}</strong>?
      </div>

      <div class="modal-footer">
        <form method="post"
              action="{% url 'delete_pracownicy' realizacja.id s.id %}">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">
            Tak, usu≈Ñ
          </button>
        </form>
        <button type="button" class="btn btn-secondary"
                data-bs-dismiss="modal">
          Anuluj
        </button>
      </div>
    </div>
  </div>
</div>
{% endfor %}
{% endif %}

<script>
function toggleWorkerSelect(select, stanowiskoId) {
  const workerDiv = document.getElementById(
    "worker-select-" + stanowiskoId
  );

  if (select.value === "worker") {
    workerDiv.classList.remove("d-none");
  } else {
    workerDiv.classList.add("d-none");
  }
}
</script>

{% endblock %}

