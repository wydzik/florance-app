{% extends "base.html" %}
{% block content %}

<h2>{{ realizacja.nazwa_eventu }}</h2>

{% if is_owner %}
  <a href="{% url 'edit_realizacja' realizacja.id %}"
     class="btn btn-outline-secondary btn-sm">
    Edytuj realizacjÄ™
  </a>
{% endif %}

<div class="mb-3">
  <strong>Organizator:</strong><br>
  {{ realizacja.pracownia.nazwa }}<br>
  {{ realizacja.pracownia.owner.imie }}
  {{ realizacja.pracownia.owner.nazwisko }}
</div>

<p><strong>Miejsce:</strong> {{ realizacja.miejsce }}</p>
<p><strong>Data:</strong>
  {{ realizacja.data_rozpoczecia }} â€“ {{ realizacja.data_zakonczenia }}
</p>

<hr>

<!-- ======================= PLIKI ======================= -->

{% if pliki %}
<h5>ðŸ“Ž Pliki do realizacji</h5>

<ul class="list-group mb-4">

{% for plik in pliki %}
<li class="list-group-item">

  <div class="d-flex justify-content-between align-items-start">

    <div>
      <a href="{{ plik.plik.url }}" target="_blank">
        {{ plik.nazwa|default:plik.plik.name }}
      </a>

      {% if not plik.widoczny_dla.all %}
        <span class="badge bg-secondary ms-2">Prywatny</span>
      {% else %}
        <span class="badge bg-info ms-2">
          Widoczny dla {{ plik.widoczny_dla.count }} osÃ³b
        </span>
      {% endif %}
    </div>

    {% if is_owner %}
    <div class="text-end">

      <!-- Toggle widocznoÅ›ci -->
      <button class="btn btn-sm btn-outline-secondary mb-2"
              data-bs-toggle="collapse"
              data-bs-target="#visibility-{{ plik.id }}">
        ZarzÄ…dzaj widocznoÅ›ciÄ…
      </button>

      <div class="collapse" id="visibility-{{ plik.id }}">

        <form method="post"
              action="{% url 'update_plik_visibility' plik.id %}">
          {% csrf_token %}

          {% for stanowisko in stanowiska %}
            {% if stanowisko.przypisany_florysta %}
              <div class="form-check text-start">
                <input class="form-check-input"
                       type="checkbox"
                       name="workers"
                       value="{{ stanowisko.przypisany_florysta.id }}"
                       {% if stanowisko.przypisany_florysta in plik.widoczny_dla.all %}
                         checked
                       {% endif %}>
                <label class="form-check-label">
                  {{ stanowisko.przypisany_florysta.imie }}
                  {{ stanowisko.przypisany_florysta.nazwisko }}
                </label>
              </div>
            {% endif %}
          {% endfor %}

          <button class="btn btn-sm btn-outline-primary mt-2">
            Zapisz
          </button>
        </form>
      </div>

      <!-- UsuÅ„ -->
      <form method="post"
            action="{% url 'delete_realizacja_plik' plik.id %}"
            class="mt-2">
        {% csrf_token %}
        <button class="btn btn-sm btn-outline-danger">
          UsuÅ„
        </button>
      </form>

    </div>
    {% endif %}

  </div>

</li>
{% endfor %}
</ul>
{% endif %}

{% if is_owner %}
<a href="{% url 'add_realizacja_plik' realizacja.id %}"
   class="btn btn-sm btn-outline-primary mb-4">
  âž• Dodaj plik
</a>
{% endif %}

<hr>

<!-- ======================= STANOWISKA ======================= -->

{% if is_owner %}
  <a class="btn btn-primary"
     href="{% url 'create_pracownicy' realizacja.pk %}">
     Dodaj stanowisko
  </a>
{% endif %}

<table class="table table-striped mt-3">
<thead>
<tr>
  <th>Data</th>
  <th>Stawka</th>
  <th>Pracownik</th>
  <th>Akcje</th>
</tr>
</thead>
<tbody>

{% for s in stanowiska %}
<tr>
  <td>{{ s.data_pracy|date:"d.m.Y" }}</td>
  <td>{{ s.stawka }}</td>

  <td>
    {% if s.przypisany_florysta %}
      {{ s.przypisany_florysta.imie }}
      {{ s.przypisany_florysta.nazwisko }}
    {% else %}
      â€”
    {% endif %}
  </td>

  <td>
    {% if is_owner %}
      <a href="{% url 'edit_pracownicy' realizacja.id s.id %}"
         class="btn btn-sm btn-outline-secondary">
        Edytuj
      </a>
    {% endif %}
  </td>
</tr>

<!-- ======================= KOMENTARZE ======================= -->

<tr>
<td colspan="4">

<div class="bg-light p-3 rounded">

<button class="btn btn-sm btn-outline-secondary"
        data-bs-toggle="collapse"
        data-bs-target="#comments-{{ s.id }}">
  ðŸ’¬ Komentarze ({{ s.visible_comments|length }})
</button>

<div class="collapse mt-3" id="comments-{{ s.id }}">

{% for komentarz in s.visible_comments %}
<div class="border rounded p-2 mb-2 bg-white">

  {% if komentarz.typ == "owner" %}
    <span class="badge bg-secondary">Tylko owner</span>
  {% elif komentarz.typ == "worker" %}
    <span class="badge bg-warning text-dark">Prywatny</span>
  {% else %}
    <span class="badge bg-info">Dla wszystkich</span>
  {% endif %}

  <small class="text-muted ms-2">
    {{ komentarz.created_at|date:"d.m.Y H:i" }}
  </small>

  <div class="mt-1">
    {{ komentarz.tresc|linebreaksbr }}
  </div>

</div>
{% empty %}
<p class="text-muted">Brak komentarzy.</p>
{% endfor %}

{% if is_owner %}
<form method="post"
      action="{% url 'add_komentarz_stanowiska' s.id %}"
      class="mt-3">
  {% csrf_token %}

  <textarea name="tresc"
            class="form-control mb-2"
            rows="2"
            required></textarea>

  <select name="typ"
          class="form-select form-select-sm mb-2"
          onchange="toggleWorkerSelect(this, {{ s.id }})">
    <option value="owner">Tylko dla mnie</option>
    <option value="worker">Tylko dla pracownika</option>
    <option value="all">Dla wszystkich</option>
  </select>

  <div id="worker-select-{{ s.id }}"
       class="d-none mb-2">
    {% if s.przypisany_florysta %}
      <input type="hidden"
             name="widoczny_dla"
             value="{{ s.przypisany_florysta.id }}">
      <div class="form-control form-control-sm bg-light">
        {{ s.przypisany_florysta.imie }}
        {{ s.przypisany_florysta.nazwisko }}
      </div>
    {% endif %}
  </div>

  <button class="btn btn-sm btn-outline-primary">
    Dodaj komentarz
  </button>
</form>
{% endif %}

</div>
</div>

</td>
</tr>

{% endfor %}
</tbody>
</table>

<script>
function toggleWorkerSelect(select, stanowiskoId) {
  const el = document.getElementById("worker-select-" + stanowiskoId);
  if (select.value === "worker") {
    el.classList.remove("d-none");
  } else {
    el.classList.add("d-none");
  }
}
</script>

{% endblock %}